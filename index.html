<!DOCTYPE html>
<html>
  <head>
    <title>ontouchstart.github.com</title>
    <style>
    </style>
    <script type="text/javascript">      
      function lockDocument() {
        document.addEventListener('touchmove', function (e) {
           e.preventDefault();
        })
      }

      function css(rule) {
        document.styleSheets[0].insertRule(rule);
      }

      function el(parent, tag) {
        var _el = document.createElement(tag);
        parent.appendChild(_el);
        return _el;
      }

      function resetCSS() {
        css(" * { position: absolute}");
        css(" * { margin: 0}");
        css(" * { padding: 0}");
        css(" * { -webkit-touch-callout:none}");
        css(" * { -webkit-user-select:none}");
        css(" * { -webkit-text-size-adjust:none}");
        css(" * { -webkit-tap-highlight-color: transparent}");
      }
      
      function holdToChange(el, text) {
        var old = el.innerHTML;
        el.ontouchstart = function () { 
          this.innerHTML = text;
        }
        el.ontouchend = function () { 
          this.innerHTML = old;
        }
      }

      function trigger(target, name, data) {
        var evt = document.createEvent('Events');
        evt.initEvent(name, true, true);
        evt.data = data;
        target.dispatchEvent(evt);
      }

      function touchMoveToSpin(sensor, listenerArray) {
        var x_min = parseInt(sensor.style.left);
        var w = parseInt(sensor.style.width);
        
        function spinCSS (angle_min, angle_max, n) {
          var angle = angle_min;
          var d = (angle_max - angle_min) / n;
          for(var i = 0; i < n; i++){
            css('.spin-' + i + ' { -webkit-transform: rotateY(' + angle + 'deg);}');
            angle += d;
          }
        }

        spinCSS(-180, 180, w);

        function spin (e) {
          var x = e.touches[0].pageX;
          var x_min = parseInt(sensor.style.left);
          var w = parseInt(sensor.style.width);
            if( x < x_min) return;
            if( x > (x_min + w)) return;
            for(var i = 0; i < listenerArray.length; i++) {
              trigger(listenerArray[i], 'spin', 'spin-' + (x - x_min));
            }
        };
        sensor.addEventListener('touchstart', spin);
        sensor.addEventListener('touchmove', spin);
      }

      function page (id) {
        var width = 640;
        var height = 480;
        var depth = 500;
        var container = el(document.body, 'div');
        container.id = id;
        container.style.width = width + 'px';
        container.style.height = height + 'px';
        container.style.webkitPerspective = depth + 'px';
        container.style.backgroundColor = '#123';
        container.style.color = '#abc';
        container.style.fontFamily = 'Helvetica';
        
        function centerContainer() {
          container.style.left = (document.body.scrollWidth - width) / 2 + 'px';
          container.style.top = (document.body.scrollHeight - height) / 2 + 'px';
        }
        centerContainer();

        window.addEventListener('resize', centerContainer);
        return container;
      }

      function helloSpin() {    
        var page1 = page("hello-spin");        
        var helloWorld = el(page1, 'h1');
        helloWorld.style.width = '100%';
        helloWorld.style.textAlign = 'center';
        helloWorld.style.bottom = '50%';

        helloWorld.innerHTML = 'Hello World';
        holdToChange(helloWorld, 'Hello World from ontouchstart');

        var spinClass = el(page1, 'h4');
        spinClass.style.width = '100%';
        spinClass.style.textAlign = 'center';
        touchMoveToSpin(page1,[helloWorld, spinClass]);

        helloWorld.addEventListener('spin', function (e) {
          this.className = e.data;
        });

        spinClass.addEventListener('spin', function (e) {
          this.innerHTML = e.data;
        });
        return page1;
      }

      window.addEventListener('load', function() {
        lockDocument();
        resetCSS();
        helloSpin();
      });
    </script>
  </head>
  <body>
  </body>
</html>
